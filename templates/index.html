<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenVPN-WEB</title>
    <link rel="icon" href="static/cropped-openvpn-32x32.png" sizes="32x32" />
    <link rel="icon" href="static/cropped-openvpn-192x192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="static/cropped-openvpn-180x180.png" />
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" type="text/css" href="static/css/buttons.bootstrap5.min.css" />
    <link rel="stylesheet" type="text/css" href="static/css/datepicker-bs5.min.css" />
    <link rel="stylesheet" href="static/css/index.css" />

    <style>
      .dropdown-menu {
        --bs-dropdown-min-width: 8rem;
      }

      td .dropdown-menu {
        --bs-dropdown-min-width: 6rem;
      }

      .dataTables_info {
        padding-top: 0 !important;
      }

      button.nav-link {
        color: rgba(255, 255, 255, 0.85) !important;
      }

      button.nav-link:hover,
      button.nav-link:focus,
      button.nav-link:active {
        color: #fff !important;
      }

      .bi {
        display: inline-block;
        vertical-align: -0.125em;
        fill: currentcolor;
      }

      th.dt-center,
      td.dt-center {
        padding-right: 26px;
      }

      .desc-item {
        padding: 0.5rem 0;
        /* border-bottom: 1px solid #dee2e6; */
      }

      .desc-item:nth-child(odd) {
        background-color: #f8f9fa;
      }
      .desc-item:nth-child(even) {
        background-color: #ffffff;
      }

      .desc-label {
        font-weight: 500;
        color: #495057;
      }

      .desc-value {
        word-wrap: break-word;
        word-break: break-all;
        white-space: normal;
        color: #212529;
      }
    </style>
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">OpenVPN</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasNavbar"
          aria-controls="offcanvasNavbar"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="offcanvas-lg offcanvas-end flex-grow-1 bg-primary"
          tabindex="-1"
          id="offcanvasNavbar"
          aria-labelledby="offcanvasNavbarLabel"
        >
          <div class="offcanvas-header">
            <h5 class="offcanvas-title text-white" id="offcanvasNavbarLabel">OpenVPN</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="offcanvas"
              data-bs-target="#offcanvasNavbar"
              aria-label="Close"
            ></button>
          </div>
          <div class="offcanvas-body">
            <ul class="navbar-nav flex-row flex-wrap ms-md-auto">
              <li class="nav-item dropdown">
                <button
                  type="button"
                  class="btn btn-link nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  data-bs-display="static"
                >
                  管理
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <span class="dropdown-item" role="button" id="showUser">
                      <svg width="1em" height="1em" fill="currentColor" class="bi" viewBox="0 0 16 16">
                        <path
                          d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"
                        />
                      </svg>
                      VPN账号
                    </span>
                  </li>
                  <li>
                    <span class="dropdown-item" role="button" id="showClient">
                      <svg width="1em" height="1em" fill="currentColor" class="bi" viewBox="0 0 16 16">
                        <path
                          d="M2.5 13.5A.5.5 0 0 1 3 13h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zM2 2h12s2 0 2 2v6s0 2-2 2H2s-2 0-2-2V4s0-2 2-2z"
                        />
                      </svg>
                      客户端
                    </span>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <span class="dropdown-item" role="button" id="showHistory">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        class="bi bi-clock-history"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z"
                        />
                        <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z" />
                        <path
                          d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5"
                        />
                      </svg>
                      历史记录
                    </span>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <h6 class="dropdown-header">openvpn</h6>
                  </li>
                  <li>
                    <span class="dropdown-item" role="button" id="sconfig">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        fill="currentColor"
                        class="bi bi-card-heading"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"
                        />
                        <path
                          d="M3 8.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0-5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5z"
                        />
                      </svg>
                      配置文件
                    </span>
                  </li>
                  <li>
                    <span class="dropdown-item" role="button" id="restartSrv">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        fill="currentColor"
                        class="bi bi-gear-wide"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M8.932.727c-.243-.97-1.62-.97-1.864 0l-.071.286a.96.96 0 0 1-1.622.434l-.205-.211c-.695-.719-1.888-.03-1.613.931l.08.284a.96.96 0 0 1-1.186 1.187l-.284-.081c-.96-.275-1.65.918-.931 1.613l.211.205a.96.96 0 0 1-.434 1.622l-.286.071c-.97.243-.97 1.62 0 1.864l.286.071a.96.96 0 0 1 .434 1.622l-.211.205c-.719.695-.03 1.888.931 1.613l.284-.08a.96.96 0 0 1 1.187 1.187l-.081.283c-.275.96.918 1.65 1.613.931l.205-.211a.96.96 0 0 1 1.622.434l.071.286c.243.97 1.62.97 1.864 0l.071-.286a.96.96 0 0 1 1.622-.434l.205.211c.695.719 1.888.03 1.613-.931l-.08-.284a.96.96 0 0 1 1.187-1.187l.283.081c.96.275 1.65-.918.931-1.613l-.211-.205a.96.96 0 0 1 .434-1.622l.286-.071c.97-.243.97-1.62 0-1.864l-.286-.071a.96.96 0 0 1-.434-1.622l.211-.205c.719-.695.03-1.888-.931-1.613l-.284.08a.96.96 0 0 1-1.187-1.186l.081-.284c.275-.96-.918-1.65-1.613-.931l-.205.211a.96.96 0 0 1-1.622-.434zM8 12.997a4.998 4.998 0 1 1 0-9.995 4.998 4.998 0 0 1 0 9.996z"
                        />
                      </svg>
                      重启服务
                    </span>
                  </li>
                  <li>
                    <span class="dropdown-item" role="button" id="manageCert">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        fill="currentColor"
                        class="bi bi-shield-shaded"
                        viewBox="0 0 16 16"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M8 14.933a1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"
                        />
                      </svg>
                      管理证书
                    </span>
                  </li>
                </ul>
              </li>
              <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
                <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white"></div>
                <hr class="d-lg-none my-2 text-white-50" />
              </li>
              <li class="nav-item dropdown">
                <button
                  type="button"
                  class="btn btn-link nav-link"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  data-bs-display="static"
                >
                  <span class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      fill="currentColor"
                      class="bi bi-person-circle"
                      viewBox="0 0 16 16"
                    >
                      <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                      <path
                        fill-rule="evenodd"
                        d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"
                      />
                    </svg>
                    {{ .sysUser }}
                  </span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" role="button" id="modifyPass">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        fill="currentColor"
                        class="bi bi-person-lock"
                        viewBox="0 0 16 16"
                      >
                        <path
                          d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m0 5.996V14H3s-1 0-1-1 1-4 6-4q.845.002 1.544.107a4.5 4.5 0 0 0-.803.918A11 11 0 0 0 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664zM9 13a1 1 0 0 1 1-1v-1a2 2 0 1 1 4 0v1a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1zm3-3a1 1 0 0 0-1 1v1h2v-1a1 1 0 0 0-1-1"
                        />
                      </svg>
                      修改密码
                    </a>
                  </li>
                  <li>
                    <hr class="dropdown-divider" />
                  </li>
                  <li>
                    <a class="dropdown-item" role="button" id="logout" href="/logout">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        fill="currentColor"
                        class="bi bi-box-arrow-right"
                        viewBox="0 0 16 16"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"
                        />
                        <path
                          fill-rule="evenodd"
                          d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"
                        />
                      </svg>
                      退出系统
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div id="serverTable" class="my-3 p-3 bg-body rounded shadow-sm" style="display: none">
        <table class="table table-borderless m-0 text-center">
          <thead class="border-bottom border-2">
            <tr>
              <th scope="col">VPN Server</th>
              <th scope="col">状态</th>
              <th scope="col">下载总流量</th>
              <th scope="col">上传总流量</th>
              <th scope="col">启动时间</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ .server.Address }}</td>
              <td>{{ .server.Status }}</td>
              <td>{{ .server.BytesIn }}</td>
              <td>{{ .server.BytesOut }}</td>
              <td>{{ .server.RunDate }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="vtableContainer" class="my-5 p-3 bg-body rounded shadow-sm">
        <table id="vtable" class="table table-striped" style="width: 100%"></table>
      </div>
    </div>

    <div class="modal fade" tabindex="-1" id="addUserModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title">添加账号</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-group mb-3">
                <label>用户名</label>
                <input
                  type="text"
                  class="form-control form-control-sm float-end w-75"
                  name="username"
                  autofocus
                  required
                />
              </div>
              <div class="form-group mb-3">
                <label>密码</label>
                <input
                  type="password"
                  autocomplete="one-time-code"
                  class="form-control form-control-sm float-end w-75"
                  name="password"
                  required
                />
              </div>
              <div class="form-group mb-3">
                <label>姓名</label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="name" required />
              </div>
              <div class="form-group mb-3">
                <label>到期时间</label>
                <input
                  type="text"
                  class="form-control form-control-sm float-end w-75"
                  name="expireDate"
                  placeholder="选择日期"
                />
              </div>
              <div class="form-group mb-3">
                <label>配置文件</label>
                <select class="form-select form-select-sm float-end w-75" name="ovpnConfig"></select>
              </div>
              <div class="form-group mb-3">
                <label>
                  IP地址
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-question-circle"
                    viewBox="0 0 16 16"
                    data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    data-bs-title="固定VPN的IP地址"
                  >
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                    <path
                      d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94"
                    ></path>
                  </svg>
                </label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="ipAddr" />
                <div class="form-text d-none mt-2" style="left: 27%; position: absolute"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" tabindex="-1" id="editUserModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title">编辑账号</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-group mb-3" hidden>
                <label>ID</label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="id" disabled />
              </div>
              <div class="form-group mb-3">
                <label>用户名</label>
                <input
                  type="text"
                  class="form-control form-control-sm float-end w-75"
                  name="username"
                  autofocus
                  required
                />
              </div>
              <div class="form-group mb-3">
                <label>姓名</label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="name" required />
              </div>
              <div class="form-group mb-3">
                <label>到期时间</label>
                <input
                  type="text"
                  class="form-control form-control-sm float-end w-75"
                  name="expireDate"
                  placeholder="选择日期"
                />
              </div>
              <div class="form-group mb-3">
                <label>配置文件</label>
                <select class="form-select form-select-sm float-end w-75" name="ovpnConfig"></select>
              </div>
              <div class="form-group mb-3">
                <label>
                  IP地址
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-question-circle"
                    viewBox="0 0 16 16"
                    data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    data-bs-title="固定VPN的IP地址"
                  >
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                    <path
                      d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94"
                    ></path>
                  </svg>
                </label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="ipAddr" />
                <div class="form-text d-none mt-2" style="left: 27%; position: absolute"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" tabindex="-1" id="addClientModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title">添加客户端</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <label class="col-sm-3 col-form-label">名称</label>
                <div class="col-sm-9">
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    name="name"
                    placeholder="客户端名称"
                    autofocus
                    required
                  />
                </div>
              </div>
              <div class="row">
                <label class="col-sm-3 col-form-label">VPNServer</label>
                <div class="col-sm-9">
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    name="serverAddr"
                    placeholder="VPN服务器外网IP或域名"
                  />
                </div>
              </div>
              <div class="row mb-2">
                <label class="col-sm-3 col-form-label">CCD配置</label>
                <div class="col-sm-9">
                  <textarea
                    class="form-control form-control-sm"
                    name="ccdConfig"
                    rows="6"
                    placeholder="ifconfig-push 10.8.0.111 255.255.255.0&#10;iroute 192.168.0.0 255.255.0.0"
                  ></textarea>
                </div>
              </div>
              <div class="row mb-2">
                <label class="col-sm-3 col-form-label">自定义配置</label>
                <div class="col-sm-9">
                  <textarea
                    class="form-control form-control-sm"
                    name="config"
                    rows="6"
                    placeholder="route 192.168.8.0 255.255.255.0&#10;redirect-gateway def1 ipv6 bypass-dhcp"
                  ></textarea>
                </div>
              </div>
              <div class="row">
                <span class="col-sm-3"></span>
                <div class="col-sm-9">
                  <input class="form-check-input" type="checkbox" name="mfa" />
                  <label class="form-check-label">启用MFA</label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" tabindex="-1" id="resetPassModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title">重置密码</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-group mb-3" hidden>
                <label>ID:</label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="id" disabled />
              </div>
              <div class="form-group mb-3">
                <label>用户名</label>
                <input type="text" class="form-control form-control-sm float-end w-75" name="username" disabled />
              </div>
              <div class="form-group mb-3">
                <label>密码</label>
                <input
                  type="password"
                  autocomplete="one-time-code"
                  class="form-control form-control-sm float-end w-75"
                  name="newPass"
                  required
                />
              </div>
              <div class="form-group mb-3">
                <label>确认密码</label>
                <input
                  type="password"
                  autocomplete="one-time-code"
                  class="form-control form-control-sm float-end w-75"
                  name="newPassAgain"
                  required
                />
                <div class="form-text d-none mt-2" style="left: 27%; position: absolute"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary" id="resetPassSumbit">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      id="renewCertModal"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title">确认更新OpenVPN证书?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <div class="mb-3">
                <label for="day">有效期(天):</label>
                <input type="number" class="form-control form-control-sm d-inline ms-3 w-25" name="day" value="3650" />
              </div>
              <span style="font-size: 14px; color: red"> 注: 会同时更新CA证书和服务器证书 </span>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary" id="renewCertSumbit">确认</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" tabindex="-1" id="modifyPassModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form>
            <div class="modal-header">
              <h5 class="modal-title">修改密码</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-group mb-3">
                <label>密码</label>
                <input
                  type="password"
                  autocomplete="one-time-code"
                  class="form-control form-control-sm float-end w-75"
                  name="newPass"
                  required
                />
              </div>
              <div class="form-group mb-3">
                <label>确认密码</label>
                <input
                  type="password"
                  autocomplete="one-time-code"
                  class="form-control form-control-sm float-end w-75"
                  name="newPassAgain"
                  required
                />
                <div class="form-text d-none mt-2" style="left: 27%; position: absolute"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary" id="modifyPassSumbit">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      id="restartInfoModal"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">提示</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="text-align: center">
            <h4>确认重启openvpn服务?</h4>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary" id="restartInfoSumbit">确认</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      id="editClientModal"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">编辑</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="form-group mb-3" hidden>
            <label>客户端</label>
            <input type="text" class="form-control form-control-lg float-end w-75" name="name" disabled />
          </div>
          <textarea class="form-control form-control-lg border border-0" name="config" rows="16"></textarea>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary" id="editClientSumbit">确认</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      id="editServerModal"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">server.conf</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <textarea class="form-control form-control-lg border border-0" name="config" rows="16"></textarea>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary" id="editServerSumbit">确认</button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      id="resetMfaInfoModal"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">提示</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="text-align: center">
            <input type="text" class="form-control form-control-sm" name="id" hidden />
            <h4>确认重置MFA?</h4>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary" id="resetMfaInfoSumbit">确认</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="alertToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <svg
            aria-hidden="true"
            class="bd-placeholder-img rounded me-2"
            height="20"
            preserveAspectRatio="xMidYMid slice"
            width="20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <rect width="100%" height="100%" fill="#007aff"></rect>
          </svg>
          <strong class="me-auto">提示</strong>
          <small></small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
      </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="userOffcanvas" aria-labelledby="userOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="userOffcanvasLabel">详情</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body"></div>
    </div>

    <footer class="fixed-bottom border-top bg-light" style="font-size: 12px">{{ .server.Version }}</footer>
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="static/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="static/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="static/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="static/js/buttons.bootstrap5.min.js"></script>
    <script type="text/javascript" src="static/js/copy-to-clipboard.js"></script>
    <script type="text/javascript" src="static/js/datepicker-full.min.js"></script>
    <script type="text/javascript" src="static/js/datepicker.zh-CN.js"></script>
    <script type="text/javascript" src="static/js/dayjs.min.js"></script>
    <script type="text/javascript" src="static/js/index.js"></script>

    <script type="text/javascript">
      $(document).ready(function () {
        let vtable;
        let qt;
        let now;
        let lastMonth;

        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));

        const tables = {
          status: {
            columns: [
              { title: '用户名/客户端', data: 'username' },
              { title: 'VPN IP', data: 'vip' },
              { title: '用户 IP', data: 'rip' },
              { title: '下载流量', data: 'recvBytes' },
              { title: '上传流量', data: 'sendBytes' },
              { title: '上线时间', data: 'connDate' },
              { title: '时长', data: 'onlineTime' },
              {
                title: '操作',
                data: (data) =>
                  `<button type="button" class="btn btn-outline-danger btn-sm" id="killClient">断开</button>`,
              },
            ],
            dom:
              "<'d-flex justify-content-between'f<'toolbar'>>" +
              "<'row'<'col-sm-12'tr>>" +
              "<'d-flex justify-content-between align-items-center'lip>",
            fnInitComplete: function () {
              const interval = setInterval(() => {
                if ($('#serverTable').is(':hidden')) {
                  clearInterval(interval);
                } else {
                  vtable.ajax.reload(null, false);
                }
              }, 30000);
            },
            ajax: function (data, callback, settings) {
              request.get('/ovpn/online-client').then((data) => callback({ data }));
            },
          },
          user: {
            autoWidth: false,
            responsive: true,
            columns: [
              {
                title: 'ID',
                data: 'id',
                visible: false,
                searchable: false,
              },
              {
                title: '用户名',
                data: (data) =>
                  `<button class="btn btn-link text-decoration-none p-0" id="showUserOffcanvas">${data.username}</button>`,
              },
              {
                title: '密码',
                data: (data) => {
                  if (data.password.length == 0) {
                    return data.password;
                  }

                  const html = `
                  <div class="form-group d-flex justify-content-center align-items-center gap-1">
                    <input class="border border-0 p-0 bg-transparent" style="outline: none;width: ${
                      data.password.length * 7
                    }px;max-width: 175px;" value="${data.password}" type="password" readonly>
                    <button class="btn btn-link p-0" id="copyPass">
                      <svg viewBox="64 64 896 896" focusable="false" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true">
                        <path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path>
                      </svg>
                    </button>
                  </div>
                  `;
                  return html;
                },
              },
              { title: 'IP地址', data: 'ipAddr' },
              { title: '配置文件', data: 'ovpnConfig' },
              {
                title: 'MFA',
                data: (data) => (data.mfaSecret ? '开启' : ''),
              },
              {
                title: '状态',
                data: (data) => {
                  const ed = new Date(data.expireDate);
                  const now = new Date();
                  ed.setHours(0, 0, 0, 0);
                  now.setHours(0, 0, 0, 0);
                  if (ed < now) {
                    return `<span class="badge text-bg-danger">已过期</span>`;
                  }

                  return data.isEnable
                    ? `<span class="badge text-bg-success">启用</span>`
                    : `<span class="badge text-bg-secondary">禁用</span>`;
                },
              },
              { title: '姓名', data: 'name' },
              {
                title: '操作',
                data: (data) => {
                  const html = `
                  <button class="btn btn-link text-decoration-none p-0" id="editUser">编辑</button>
                  ${
                    data.isEnable === true
                      ? '<button class="btn btn-link text-decoration-none p-0" id="disableUser">禁用</button>'
                      : '<button class="btn btn-link text-decoration-none p-0" id="enableUser">启用</button>'
                  }
                  <button class="btn btn-link text-decoration-none p-0" id="delUser">删除</button>
                  <div class="btn btn-link text-decoration-none p-0 dropdown">
                    <button class="btn btn-link text-decoration-none p-0 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      更多
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" id="resetPass">重置密码</a></li>
                      <li><a class="dropdown-item" id="resetMfa">重置MFA</a></li>
                    </ul>
                  </div>
                  `;
                  return html;
                },
              },
            ],
            order: [[0, 'desc']],
            buttons: {
              dom: {
                button: { className: 'btn btn-sm' },
              },
              buttons: [
                {
                  text: '添加',
                  className: 'btn-primary',
                  action: () => {
                    const elem = document.querySelector('#addUserModal input[name="expireDate"]');
                    const datepicker = new Datepicker(elem, {
                      buttonClass: 'btn',
                      format: 'yyyy-mm-dd',
                      autohide: true,
                      language: 'zh-CN',
                      orientation: 'top',
                      minDate: new Date(),
                    });

                    request.get('/ovpn/client').then((data) => {
                      $('#addUserModal select[name="ovpnConfig"]').html(
                        data.map((i) => `<option value="${i.fullName}">${i.name}</option>`)
                      );

                      $('#addUserModal').modal('show');
                    });
                  },
                },
              ],
            },
            dom:
              "<'row align-items-center'<'col d-flex'f><'col d-flex justify-content-center toolbar'><'col d-flex justify-content-end'B>>" +
              "<'row'<'col-sm-12'tr>>" +
              "<'d-flex justify-content-between align-items-center'lip>",
            fnInitComplete: function (oSettings, data) {
              $('#vtable_wrapper div.toolbar').html(
                `<div class="form-check form-switch form-check-reverse">
                  <input class="form-check-input" type="checkbox" role="switch" id="authUser" style="cursor: pointer;" ${
                    data.authUser ? 'checked' : ''
                  }>
                  <label class="form-check-label" for="authUser">账号启用: </label>
                </div>
                `
              );
            },
            ajax: function (data, callback, settings) {
              request.get('/ovpn/user').then((data) => callback({ data: data?.users, authUser: data?.authUser }));
            },
          },
          history: {
            columns: [
              { title: '用户名', data: 'username' },
              { title: '客户端', data: 'common_name' },
              { title: 'VPN IP', data: 'vip' },
              { title: '用户 IP', data: 'rip' },
              { title: '下载流量', data: 'bytes_received' },
              { title: '上传流量', data: 'bytes_sent' },
              { title: '上线时间', data: 'time_unix' },
              { title: '在线时长', data: 'time_duration' },
            ],
            order: [[6, 'desc']],
            processing: true,
            serverSide: true,
            search: {
              return: true,
            },
            dom:
              "<'row align-items-center'<'col d-flex'f><'col d-flex justify-content-center toolbar'><'col d-flex justify-content-end'B>>" +
              "<'row'<'col-sm-12'tr>>" +
              "<'d-flex justify-content-between align-items-center'lip>",
            fnInitComplete: function (oSettings, data) {
              $('#vtable_wrapper div.toolbar').html(
                `<div id="datepicker">
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control text-center" name="start" />
                    <span class="input-group-text">to</span>
                    <input type="text" class="form-control text-center" name="end" />
                  </div>
                </div>
                `
              );

              const elem = document.getElementById('datepicker');
              const rangepicker = new DateRangePicker(elem, {
                buttonClass: 'btn',
                container: elem,
                format: 'yyyy-mm-dd',
                autohide: true,
                language: 'zh-CN',
              });

              rangepicker.setDates(lastMonth, now);

              elem.addEventListener('changeDate', (e) => {
                qt = rangepicker.getDates().map((d, i) => {
                  if (d instanceof Date) {
                    if (i == 1) {
                      d.setHours(23, 59, 59, 0);
                    }

                    return Date.parse(d) / 1000;
                  }

                  return qt[i];
                });

                vtable.ajax.reload();
              });
            },
            buttons: {
              dom: {
                button: { className: 'btn btn-sm' },
              },
              buttons: [
                {
                  text: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/> <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/> </svg> 刷新 ',
                  className: 'btn-primary',
                  action: () => vtable.ajax.reload(),
                },
              ],
            },
            ajax: function (data, callback, settings) {
              const orderColumn = data.columns[data.order[0].column].data;
              const order = data.order[0].dir;
              const params = {
                draw: data.draw,
                offset: data.start,
                limit: data.length,
                orderColumn: orderColumn,
                order: order,
                search: data.search.value,
                qt: qt.join(),
              };

              request.get(`/ovpn/history?${new URLSearchParams(params).toString()}`).then((data) => callback(data));
            },
          },
          client: {
            columns: [
              { title: '名称', data: 'name' },
              { title: '日期', data: 'date' },
              {
                title: '操作',
                data: (data) => {
                  const html = `
                  <div class="d-grid gap-2 d-flex justify-content-center align-items-center">
                    <a href="${data.file}" download="${data.fullName}" class="text-decoration-none">下载</a>
                    <div class="dropdown">
                      <button class="btn btn-link text-decoration-none p-0 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        编辑
                      </button>
                      <ul class="dropdown-menu">
                        <li><button type="button" class="dropdown-item" id="editCCD">CCD配置</button></li>
                        <li><button type="button" class="dropdown-item" id="editClient">客户端配置</button></li>
                      </ul>
                    </div>
                    <button class="btn btn-link text-decoration-none p-0" id="delClient">删除</button>
                  </div>
                  `;
                  return html;
                },
              },
            ],
            order: [[1, 'desc']],
            buttons: {
              dom: {
                button: { className: 'btn btn-sm' },
              },
              buttons: [
                {
                  text: '添加',
                  className: 'btn-primary',
                  action: () => $('#addClientModal').modal('show'),
                },
              ],
            },
            dom:
              "<'d-flex justify-content-between align-items-center'fB>" +
              "<'row'<'col-sm-12'tr>>" +
              "<'d-flex justify-content-between align-items-center'lip>",
            ajax: function (data, callback, settings) {
              request.get('/ovpn/client').then((data) => callback({ data }));
            },
          },
          cert: {
            columns: [
              { title: '名称', data: 'name' },
              { title: '类型', data: 'type' },
              {
                title: '状态',
                data: (data) => {
                  let badgeClass = 'text-bg-success';
                  if (data.status === '已过期') {
                    badgeClass = 'text-bg-danger';
                  } else if (data.status === '即将过期') {
                    badgeClass = 'text-bg-warning';
                  }
                  return `<span class="badge ${badgeClass}">${data.status}</span>`;
                },
              },
              { title: '颁发时间', data: 'notBefore' },
              { title: '过期时间', data: 'notAfter' },
              { title: '剩余天数', data: 'expiresIn' },
            ],
            order: [[3, 'desc']],
            buttons: {
              dom: {
                button: { className: 'btn btn-sm' },
              },
              buttons: [
                {
                  text: '更新证书',
                  className: 'btn-primary',
                  action: () => $('#renewCertModal').modal('show'),
                },
              ],
            },
            dom:
              "<'d-flex justify-content-between align-items-center'fB>" +
              "<'row'<'col-sm-12'tr>>" +
              "<'d-flex justify-content-between align-items-center'lip>",
            ajax: function (data, callback, settings) {
              request.get('/ovpn/certs').then((data) => callback({ data }));
            },
          },
        };

        const initTable = (tab) => {
          if (tab === 'status') {
            $('#vtableContainer').removeClass('my-3').addClass('my-5');
            $('#serverTable').show();
          } else {
            $('#vtableContainer').removeClass('my-5').addClass('my-3');
            $('#serverTable').hide();
          }

          if (tab === 'history') {
            now = new Date();
            lastMonth = new Date(now);
            lastMonth.setMonth(now.getMonth() - 1);
            lastMonth.setHours(0, 0, 0, 0);
            now.setHours(23, 59, 59, 0);
            qt = [Date.parse(lastMonth) / 1000, Date.parse(now) / 1000];
          }

          if (vtable) {
            vtable.destroy();
            $('#vtable').empty();
          }

          vtable = $('#vtable').DataTable({
            language: {
              url: '/static/zh.json',
              loadingRecords: '数据加载中...',
            },
            columnDefs: [{ className: 'dt-center', targets: '_all' }],
            drawCallback: function () {
              $('ul.pagination').addClass('pagination-sm');
            },
            ...tables[tab],
          });
        };

        const urlParams = new URLSearchParams(window.location.search);
        const tabs = Object.keys(tables);

        if (tabs.includes(urlParams.get('tab'))) {
          initTable(urlParams.get('tab'));
        } else {
          initTable('status');
        }

        $('#showUser').click(function () {
          window.history.pushState(null, '', '?tab=user');
          initTable('user');
          if ('{{.ldapAuth}}' == 'true') {
            const toast = $('#alertToast');
            toast.find('.toast-body').text('已启用LDAP认证，本地VPN账号将不在工作！');
            bootstrap.Toast.getOrCreateInstance(toast).show();
          }
        });

        $('#showHistory').click(function () {
          window.history.pushState(null, '', '?tab=history');
          initTable('history');
        });

        $('#showClient').click(function () {
          window.history.pushState(null, '', '?tab=client');
          initTable('client');
        });

        $('#manageCert').click(function () {
          window.history.pushState(null, '', '?tab=cert');
          initTable('cert');
        });

        $('#renewCertModal form').submit(function () {
          const day = $('#renewCertModal input[name="day"]').val();

          $('#renewCertModal').modal('hide');

          request.post('/ovpn/server', { action: 'renewCert', day }).then((data) => {
            message.success(data.message);
            vtable.ajax.reload(null, false);
          });
          return false;
        });

        $('#restartSrv').click(function () {
          $('#restartInfoModal').modal('show');
        });

        $('#restartInfoSumbit').click(function () {
          request.post('/ovpn/server', { action: 'restartSrv' }).then((data) => {
            $('#restartInfoModal').modal('hide');
            message.success(data.message);
          });
        });

        $('#sconfig').click(function () {
          request.post('/ovpn/server', { action: 'getConfig' }).then((data) => {
            $('#editServerModal textarea[name="config"]').val(data.content);
            $('#editServerModal').modal('show');
          });
        });

        $('#editServerSumbit').click(function () {
          const content = $('#editServerModal textarea[name="config"]').val();

          $('#editServerModal').modal('hide');
          request.post('/ovpn/server', { action: 'updateConfig', content }).then((data) => {
            message.success(data.message);
          });
        });

        $('#addUserModal form').submit(function () {
          const name = $('#addUserModal input[name="name"]').val();
          const username = $('#addUserModal input[name="username"]').val();
          const password = $('#addUserModal input[name="password"]').val();
          const ipAddr = $('#addUserModal input[name="ipAddr"]').val();
          const expireDate = $('#addUserModal input[name="expireDate"]').val();
          const ovpnConfig = $('#addUserModal select[name="ovpnConfig"]').val() || '';

          request
            .post('/ovpn/user', {
              name,
              username,
              password,
              ipAddr,
              expireDate,
              ovpnConfig,
            })
            .then((data) => {
              vtable.ajax.reload(null, false);
              vtable.columns.adjust().draw(false);
              $('#addUserModal form').trigger('reset');
              $('#addUserModal').modal('hide');
            });

          return false;
        });

        $(document).on('keyup', '#addUserModal input[name="ipAddr"]', function () {
          const ipAddr = $('#addUserModal input[name="ipAddr"]').val();
          const regex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

          if (regex.test(ipAddr) || ipAddr.length == 0) {
            $('#addUserModal .form-text').addClass('d-none');
            $('#addUserModal input[name="ipAddr"]').removeClass('border border-danger');
            $('#addUserModal :submit').removeAttr('disabled');
          } else {
            $('#addUserModal .form-text').text('非法IP地址！');
            $('#addUserModal .form-text').addClass('text-danger');
            $('#addUserModal input[name="ipAddr"]').addClass('border border-danger');
            $('#addUserModal .form-text').removeClass('d-none');
            $('#addUserModal :submit').attr('disabled', true);
          }
        });

        $('#addClientModal form').submit(function () {
          const name = $('#addClientModal input[name="name"]').val();
          const serverAddr = $('#addClientModal input[name="serverAddr"]').val() || location.hostname;
          const config = $('#addClientModal textarea[name="config"]').val();
          const ccdConfig = $('#addClientModal textarea[name="ccdConfig"]').val();
          const mfa = $('#addClientModal input[name="mfa"]').is(':checked');

          request.post('/ovpn/client', { name, serverAddr, config, ccdConfig, mfa }).then((data) => {
            vtable.ajax.reload(null, false);
            $('#addClientModal').modal('hide');
            $('#addClientModal form').trigger('reset');
            message.success(data.message);
          });

          return false;
        });

        $(document).on('click', '#killClient', function () {
          const id = vtable.row($(this).parents('tr')).data().id;

          request.post('/ovpn/kill', { cid: id }).then(() => {
            vtable.cell(this).row().remove().draw();
          });
        });

        $(document).on('click', '#delUser', function () {
          const id = vtable.row($(this).parents('tr')).data().id;

          request.delete(`/ovpn/user/${id}`).then((data) => {
            message.success(data.message);
            vtable.ajax.reload(null, false);
          });
        });

        $(document).on('click', '#delClient', function () {
          const name = vtable.row($(this).parents('tr')).data().name;

          request.delete(`/ovpn/client/${name}`).then((data) => {
            message.success(data.message);
            vtable.ajax.reload(null, false);
          });
        });

        $(document).on('click', '#editClient', function () {
          const name = vtable.row($(this).parents('tr')).data().name;
          $('#editClientModal input[name="name"]').val(`clients/${name}.ovpn`);

          request.get(`/ovpn/client?a=getConfig&file=clients/${name}.ovpn`).then((data) => {
            $('#editClientModal textarea[name="config"]').val(data.content);
            $('#editClientModal').modal('show');
          });
        });

        $(document).on('click', '#editCCD', function () {
          const name = vtable.row($(this).parents('tr')).data().name;
          $('#editClientModal input[name="name"]').val(`ccd/${name}`);

          request.get(`/ovpn/client?a=getConfig&file=ccd/${name}`).then((data) => {
            $('#editClientModal textarea[name="config"]').val(data.content);
            $('#editClientModal').modal('show');
          });
        });

        $('#editClientSumbit').click(function () {
          const name = $('#editClientModal input[name="name"]').val();
          const content = $('#editClientModal textarea[name="config"]').val();

          $('#editClientModal').modal('hide');
          request.put(`/ovpn/client?file=${name}`, { content }).then((data) => {
            message.success(data.message);
          });
        });

        $(document).on('click', '#disableUser', function () {
          const id = vtable.row($(this).parents('tr')).data().id;

          request.patch('/ovpn/user', { id, isEnable: false }).then((data) => {
            message.success(data.message);
            vtable.ajax.reload(null, false);
          });
        });

        $(document).on('click', '#enableUser', function () {
          const id = vtable.row($(this).parents('tr')).data().id;

          request.patch('/ovpn/user', { id, isEnable: true }).then((data) => {
            message.success(data.message);
            vtable.ajax.reload(null, false);
          });
        });

        $(document).on('click', '#editUser', function () {
          const id = vtable.row($(this).parents('tr')).data().id;
          const name = vtable.row($(this).parents('tr')).data().name;
          const username = vtable.row($(this).parents('tr')).data().username;
          const ipAddr = vtable.row($(this).parents('tr')).data().ipAddr;
          const expireDate = vtable.row($(this).parents('tr')).data().expireDate;
          const ovpnConfig = vtable.row($(this).parents('tr')).data().ovpnConfig;

          $('#editUserModal input[name="id"]').val(id);
          $('#editUserModal input[name="name"]').val(name);
          $('#editUserModal input[name="username"]').val(username);
          $('#editUserModal input[name="ipAddr"]').val(ipAddr);
          $('#editUserModal input[name="expireDate"]').val(expireDate);

          request.get('/ovpn/client').then((data) => {
            $('#editUserModal select[name="ovpnConfig"]').html(
              data.map((i) => {
                if (i.fullName === ovpnConfig) {
                  return `<option value="${i.fullName}" selected>${i.name}</option>`;
                }

                return `<option value="${i.fullName}">${i.name}</option>`;
              })
            );
          });

          $('#editUserModal select[name="ovpnConfig"]').val(ovpnConfig);

          const elem = document.querySelector('#editUserModal input[name="expireDate"]');
          const datepicker = new Datepicker(elem, {
            buttonClass: 'btn',
            format: 'yyyy-mm-dd',
            autohide: true,
            language: 'zh-CN',
            orientation: 'top',
            minDate: new Date(),
          });

          datepicker.setDate(new Date(expireDate));

          $('#editUserModal').modal('show');
        });

        $('#editUserModal form').submit(function () {
          const id = $('#editUserModal input[name="id"]').val();
          const name = $('#editUserModal input[name="name"]').val();
          const username = $('#editUserModal input[name="username"]').val();
          const ipAddr = $('#editUserModal input[name="ipAddr"]').val();
          const expireDate = $('#editUserModal input[name="expireDate"]').val();
          const ovpnConfig = $('#editUserModal select[name="ovpnConfig"]').val() || '';

          request.patch('/ovpn/user', { id, name, username, ipAddr, expireDate, ovpnConfig }).then((data) => {
            vtable.ajax.reload(null, false);
            $('#editUserModal').modal('hide');
            message.success(data.message);
          });

          return false;
        });

        $(document).on('keyup', '#editUserModal input[name="ipAddr"]', function () {
          const ipAddr = $('#editUserModal input[name="ipAddr"]').val();
          const regex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

          if (regex.test(ipAddr) || ipAddr.length == 0) {
            $('#editUserModal .form-text').addClass('d-none');
            $('#editUserModal input[name="ipAddr"]').removeClass('border border-danger');
            $('#editUserModal :submit').removeAttr('disabled');
          } else {
            $('#editUserModal .form-text').text('非法IP地址！');
            $('#editUserModal .form-text').addClass('text-danger');
            $('#editUserModal input[name="ipAddr"]').addClass('border border-danger');
            $('#editUserModal .form-text').removeClass('d-none');
            $('#editUserModal :submit').attr('disabled', true);
          }
        });

        $(document).on('click', '#resetPass', function () {
          const id = vtable.row($(this).parents('tr')).data().id;
          const username = vtable.row($(this).parents('tr')).data().username;
          $('#resetPassModal input[name="id"]').val(id);
          $('#resetPassModal input[name="username"]').val(username);

          $('#resetPassModal').modal('show');
        });

        $(document).on('click', '#copyPass', function () {
          copyToClipboard(this.previousSibling.previousSibling.value?.trim());

          const icon = $(this).html();
          $(this).html(`
          <svg width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16">
            <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
          </svg>`);
          $(this).addClass('text-success');
          $(this).attr('disabled', true);

          setTimeout(() => {
            $(this).html(icon);
            $(this).removeClass('text-success');
            $(this).attr('disabled', false);
          }, 1500);
        });

        $(document).on('keyup', '#resetPassModal input[name="newPassAgain"]', function () {
          const newPss = $('#resetPassModal input[name="newPass"]').val();
          const newPassAgain = $('#resetPassModal input[name="newPassAgain"]').val();

          if (newPassAgain == newPss) {
            $('#resetPassModal .form-text').addClass('d-none');
            $('#resetPassModal input[name="newPassAgain"]').removeClass('border border-danger');
            $('#resetPassSumbit').removeAttr('disabled');
          } else {
            $('#resetPassModal .form-text').text('密码不一致！');
            $('#resetPassModal .form-text').addClass('text-danger');
            $('#resetPassModal input[name="newPassAgain"]').addClass('border border-danger');
            $('#resetPassModal .form-text').removeClass('d-none');
            $('#resetPassSumbit').attr('disabled', true);
          }
        });

        $('#resetPassModal form').submit(function () {
          const id = $('#resetPassModal input[name="id"]').val();
          const newPass = $('#resetPassModal input[name="newPassAgain"]').val();

          request.patch('/ovpn/user', { id, password: newPass }).then(() => {
            vtable.ajax.reload(null, false);
            $('#resetPassModal form').trigger('reset');
            $('#resetPassModal').modal('hide');
            message.success('密码重置成功');
          });

          return false;
        });

        $(document).on('click', '#modifyPass', function () {
          $('#modifyPassModal').modal('show');
        });

        $(document).on('keyup', '#modifyPassModal input[name="newPassAgain"]', function () {
          const newPss = $('#modifyPassModal input[name="newPass"]').val();
          const newPassAgain = $('#modifyPassModal input[name="newPassAgain"]').val();

          if (newPassAgain == newPss) {
            $('#modifyPassModal .form-text').addClass('d-none');
            $('#modifyPassModal input[name="newPassAgain"]').removeClass('border border-danger');
            $('#modifyPassSumbit').removeAttr('disabled');
          } else {
            $('#modifyPassModal .form-text').text('密码不一致！');
            $('#modifyPassModal .form-text').addClass('text-danger');
            $('#modifyPassModal input[name="newPassAgain"]').addClass('border border-danger');
            $('#modifyPassModal .form-text').removeClass('d-none');
            $('#modifyPassSumbit').attr('disabled', true);
          }
        });

        $('#modifyPassModal form').submit(function () {
          let newPass = $('#modifyPassModal input[name="newPassAgain"]').val();

          request.post('/user', { username: '{{ .sysUser }}', password: newPass }).then(() => {
            $('#modifyPassModal form').trigger('reset');
            $('#modifyPassModal').modal('hide');
            message.success('密码修改成功');
          });

          return false;
        });

        $(document).on('change', '#authUser', function () {
          request
            .post('/ovpn/server', {
              action: 'settings',
              key: 'auth-user',
              value: $(this).is(':checked'),
            })
            .then((data) => {
              message.success(data.message);
            })
            .catch(() => {
              $('#authUser').prop('checked', false);
            });
        });

        $(document).on('click', '#resetMfa', function () {
          const id = vtable.row($(this).parents('tr')).data().id;
          $('#resetMfaInfoModal input[name="id"]').val(id);
          $('#resetMfaInfoModal').modal('show');
        });

        $('#resetMfaInfoSumbit').click(function () {
          const id = $('#resetMfaInfoModal input[name="id"]').val();
          request.delete(`/client/mfa/${id}`).then((data) => {
            $('#resetMfaInfoModal').modal('hide');
            message.success('MFA已重置');
            vtable.ajax.reload(null, false);
          });
        });

        $(document).on('click', '#showUserOffcanvas', function () {
          const data = vtable.row($(this).parents('tr')).data();
          const oc = new bootstrap.Offcanvas($('#userOffcanvas'));

          const ed = new Date(data.expireDate);
          const now = new Date();
          ed.setHours(0, 0, 0, 0);
          now.setHours(0, 0, 0, 0);

          const html = `
          <div class="desc-item row">
            <div class="col-5 desc-label">ID</div>
            <div class="col-7 desc-value">${data.id}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">用户名</div>
            <div class="col-7 desc-value">${data.username}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">密码</div>
            <div class="col-7 desc-value">${data.password}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">IP地址</div>
            <div class="col-7 desc-value">${data.ipAddr}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">配置文件</div>
            <div class="col-7 desc-value">${data.ovpnConfig}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">MFA</div>
            <div class="col-7 desc-value">${data.mfaSecret}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">状态</div>
            <div class="col-7 desc-value">${ed < now ? '已过期' : data.isEnable ? '启用' : '禁用'}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">姓名</div>
            <div class="col-7 desc-value">${data.name}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">过期时间</div>
            <div class="col-7 desc-value">
              ${data.expireDate ? dayjs(data.expireDate).format('YYYY-MM-DD HH:mm:ss') : ''}
            </div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">创建时间</div>
            <div class="col-7 desc-value">${dayjs(data.createdAt).format('YYYY-MM-DD HH:mm:ss')}</div>
          </div>
          <div class="desc-item row">
            <div class="col-5 desc-label">更新时间</div>
            <div class="col-7 desc-value">${dayjs(data.updatedAt).format('YYYY-MM-DD HH:mm:ss')}</div>
          </div>
          `;

          $('#userOffcanvas .offcanvas-body').html(html);
          oc.show();
        });
      });
    </script>
  </body>
</html>
